<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Форма заявки на товар | Telegram Bot</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    :root{
      --primary:#4f46e5;
      --primary-light:#818cf8;
      --primary-dark:#3730a3;
      --secondary:#10b981;

      --light-bg:#f8fafc;
      --white:#ffffff;

      --gray-100:#f1f5f9;
      --gray-200:#e2e8f0;
      --gray-300:#cbd5e1;
      --gray-700:#334155;
      --gray-900:#0f172a;

      --border-radius:12px;
      --border-radius-sm:8px;
      --box-shadow:0 10px 25px rgba(0,0,0,0.06);
      --transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
    }

    html{scroll-behavior:smooth}
    body{
      background: linear-gradient(135deg, #f0f4ff 0%, #e6f7ff 100%);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;     /* важно для скролла */
      padding:16px;
      color:var(--gray-900);
      overflow-y:auto;            /* включаем вертикальный скролл */
      overflow-x:hidden;
    }

    /* легкая динамика фона */
    body::before{
      content:"";
      position:fixed;
      inset:-40px;
      background:
        radial-gradient(700px 450px at 12% 18%, rgba(79,70,229,.18), transparent 55%),
        radial-gradient(650px 430px at 90% 22%, rgba(16,185,129,.14), transparent 55%),
        radial-gradient(900px 550px at 55% 90%, rgba(129,140,248,.18), transparent 60%);
      filter:saturate(1.05);
      animation: drift 14s ease-in-out infinite alternate;
      pointer-events:none;
      z-index:-1;
    }
    @keyframes drift{
      from{transform:translate3d(0,0,0) scale(1)}
      to{transform:translate3d(18px,-10px,0) scale(1.03)}
    }

    .container{
      width:100%;
      max-width:520px;
      background:var(--white);
      border-radius:var(--border-radius);
      box-shadow:var(--box-shadow);
      overflow:hidden;
      border:1px solid var(--gray-200);

      /* чтобы не резало на маленьких экранах */
      max-height: calc(100vh - 32px);
      display:flex;
      flex-direction:column;
    }

    .header{
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
      color:var(--white);
      padding:22px 20px;
      text-align:center;
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .header::before{
      content:'';
      position:absolute;
      inset:-60%;
      background: radial-gradient(circle, rgba(255,255,255,0.12) 1px, transparent 1px);
      background-size: 20px 20px;
      animation: float 20s linear infinite;
    }
    @keyframes float{
      0%{transform:translate(0,0) rotate(0deg)}
      100%{transform:translate(-10px,-10px) rotate(360deg)}
    }
    .header-content{position:relative;z-index:2}
    .header h1{
      font-size:1.35rem;
      font-weight:800;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .header p{opacity:.92;font-size:.92rem}

    .progress-bar{
      display:flex;
      justify-content:center;
      padding:16px 20px 0;
      gap:8px;
      background:var(--white);
      flex: 0 0 auto;
    }
    .progress-step{
      width:32px;height:32px;
      border-radius:50%;
      background:var(--gray-200);
      color:var(--gray-700);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:.9rem;
      transition:var(--transition);
      position:relative;
      user-select:none;
    }
    .progress-step.active{background:var(--primary);color:var(--white);transform:scale(1.1)}
    .progress-step.completed{background:var(--secondary);color:var(--white)}
    .progress-step::after{
      content:'';
      position:absolute;
      top:50%;left:100%;
      width:16px;height:2px;
      background:var(--gray-200);
      transform:translateY(-50%);
    }
    .progress-step:last-child::after{display:none}

    /* скролл внутри формы */
    .form-container{
      padding:20px;
      position:relative;

      flex: 1 1 auto;
      min-height: 0;       /* важно для flex+scroll */
      overflow-y:auto;     /* скролл вниз */
      overflow-x:hidden;
      background:var(--white);
    }

    .form-step{display:none;animation:slideIn .5s ease forwards}
    .form-step.active{display:block}
    @keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
    @keyframes slideOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-30px)}}

    .step-title{
      font-size:1.12rem;
      font-weight:900;
      color:var(--gray-900);
      margin-bottom:14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .step-title i{color:var(--primary)}

    .category-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
      margin-bottom:14px;
    }
    @media (max-width:480px){ .category-grid{grid-template-columns:1fr} }

    .category-item{
      background:var(--light-bg);
      border:2px solid var(--gray-200);
      border-radius:var(--border-radius-sm);
      padding:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      cursor:pointer;
      transition:var(--transition);
      position:relative;
      min-height: 150px;
    }
    .category-item:hover{
      transform:translateY(-4px);
      border-color:var(--primary-light);
      box-shadow:0 8px 20px rgba(79,70,229,.1);
    }
    .category-item.selected{
      border-color:var(--primary);
      background:rgba(79,70,229,.06);
    }
    .category-icon{
      width:54px;height:54px;
      background:linear-gradient(135deg,var(--primary-light),var(--primary));
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:10px;
      color:#fff;
      font-size:1.35rem;
    }
    .category-name{font-weight:900;margin-bottom:6px;color:var(--gray-900)}
    .category-desc{font-size:.85rem;color:var(--gray-700);line-height:1.35}

    .checkbox-wrapper{position:absolute;top:10px;right:10px}
    .custom-checkbox{
      width:22px;height:22px;
      border:2px solid var(--gray-300);
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:var(--transition);
      background:#fff;
    }
    .custom-checkbox.checked{background:var(--primary);border-color:var(--primary)}
    .custom-checkbox.checked::after{content:'✓';color:#fff;font-weight:900;font-size:14px}

    .input-group{margin-bottom:14px}
    .input-group label{
      display:block;
      font-weight:900;
      margin-bottom:8px;
      color:var(--gray-900);
      font-size:.95rem;
    }
    .input-group input, .input-group select, .input-group textarea{
      width:100%;
      padding:13px 14px;
      border:2px solid var(--gray-200);
      border-radius:var(--border-radius-sm);
      font-size:1rem;
      transition:var(--transition);
      background:#fff;
    }
    .input-group textarea{min-height:86px;resize:vertical}
    .input-group input:focus, .input-group select:focus, .input-group textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(79,70,229,.1);
    }

    .row3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width:480px){ .row3{grid-template-columns:1fr} }

    .services-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:10px}
    .service-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px;
      border:2px solid var(--gray-200);
      border-radius:var(--border-radius-sm);
      transition:var(--transition);
      cursor:pointer;
      background:#fff;
    }
    .service-item:hover{border-color:var(--primary-light);transform:translateX(4px)}
    .service-info{display:flex;align-items:center;gap:12px}
    .service-icon{
      width:40px;height:40px;
      background:var(--light-bg);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--primary);
      font-size:1.05rem;
    }
    .service-name{font-weight:900;color:var(--gray-900)}

    .map-container{
      height:280px;
      border-radius:var(--border-radius-sm);
      overflow:hidden;
      margin-bottom:14px;
      border:2px solid var(--gray-200);
      position:relative;
      background:#fff;
    }
    #map{height:100%;width:100%}
    .map-instructions{
      position:absolute;
      top:10px;left:10px;right:10px;
      background:rgba(255,255,255,.95);
      padding:10px 12px;
      border-radius:var(--border-radius-sm);
      font-size:.88rem;
      z-index:1000;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .map-point{display:flex;align-items:center;gap:8px;font-weight:800}
    .point-indicator{
      width:14px;height:14px;border-radius:50%;
      border:3px solid #fff;
    }
    .point-1{background:var(--primary)}
    .point-2{background:var(--secondary)}

    /* панели кнопок — доступны при скролле */
    .controls{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--gray-200);
      background:#fff;
      position:relative; /* не fixed */
    }
    @media (max-width:480px){
      .controls{flex-direction:column}
    }
    .btn{
      padding:13px 16px;
      border-radius:var(--border-radius-sm);
      font-weight:900;
      font-size:1rem;
      cursor:pointer;
      transition:var(--transition);
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-width: 150px;
      user-select:none;
      white-space:nowrap;
    }
    .btn-prev{
      background:var(--gray-100);
      color:var(--gray-700);
      border:2px solid var(--gray-200);
    }
    .btn-prev:hover{background:var(--gray-200);transform:translateX(-2px)}
    .btn-next, .btn-submit{
      background:linear-gradient(90deg,var(--primary) 0%, var(--primary-light) 100%);
      color:#fff;
    }
    .btn-next:hover, .btn-submit:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(79,70,229,.3);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none !important;box-shadow:none !important}

    .tiny{font-size:.85rem;color:var(--gray-700);line-height:1.4}

    /* overlay “запрос принят” */
    .accept-overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      background: rgba(255,255,255,.86);
      backdrop-filter: blur(6px);
      z-index:50;
    }
    .accept-overlay.show{display:flex}
    .accept-card{
      width:100%;
      max-width: 440px;
      border-radius: var(--border-radius);
      border: 1px solid var(--gray-200);
      overflow:hidden;
      box-shadow: var(--box-shadow);
      background:#fff;
    }
    .accept-top{
      padding:18px 16px;
      color:#fff;
      background: linear-gradient(120deg, #4f46e5, #06b6d4, #10b981, #818cf8);
      background-size: 300% 300%;
      animation: gradMove 3.2s ease-in-out infinite;
    }
    @keyframes gradMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .accept-top h3{
      display:flex;align-items:center;gap:10px;
      font-size:1.12rem;font-weight:900;margin:0;
    }
    .accept-top .tiny{color:rgba(255,255,255,.92);margin-top:6px}
    .accept-body{padding:16px}
    .accept-body p{color:var(--gray-700);line-height:1.5;margin:0 0 12px}
    .sql-box{
      border:2px solid var(--gray-200);
      border-radius: var(--border-radius-sm);
      padding:12px;
      background:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:var(--gray-900);
      white-space:pre-wrap;
      word-break:break-word;
      max-height: 220px;
      overflow:auto;
    }
    .accept-actions{
      display:flex; gap:10px; padding: 0 16px 16px;
    }
    .mini-btn{
      flex:1;
      padding:12px 12px;
      border-radius: var(--border-radius-sm);
      font-weight:900;
      border:2px solid var(--gray-200);
      background:#fff;
      cursor:pointer;
      transition: var(--transition);
    }
    .mini-btn:hover{transform:translateY(-1px)}
    .mini-btn.primary{
      border:none;color:#fff;
      background: linear-gradient(90deg,var(--primary) 0%, var(--primary-light) 100%);
    }
  </style>
</head>

<body>
  <div class="container" id="app">
    <div class="header">
      <div class="header-content">
        <h1><i class="fas fa-boxes"></i> Форма заявки на товар</h1>
        <p>Категория → Размеры → Услуги → Склад/Карта/Контакты → SQL</p>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-step active" data-step="1">1</div>
      <div class="progress-step" data-step="2">2</div>
      <div class="progress-step" data-step="3">3</div>
      <div class="progress-step" data-step="4">4</div>
    </div>

    <div class="form-container">
      <!-- overlay -->
      <div class="accept-overlay" id="acceptOverlay">
        <div class="accept-card">
          <div class="accept-top">
            <h3><i class="fas fa-check"></i> Запрос принят</h3>
            <div class="tiny" id="acceptSub">ID: —</div>
          </div>
          <div class="accept-body">
            <p>SQL (пример) для записи результата после “Отправка запроса”:</p>
            <div class="sql-box" id="sqlBox"></div>
          </div>
          <div class="accept-actions">
            <button class="mini-btn" id="copySqlBtn">Копировать SQL</button>
            <button class="mini-btn primary" id="closeOverlayBtn">Закрыть</button>
          </div>
        </div>
      </div>

      <!-- STEP 1 -->
      <div class="form-step active" id="step1">
        <h2 class="step-title"><i class="fas fa-list"></i> Категория товара + Другое</h2>

        <div class="category-grid">
          <div class="category-item" data-category="1">
            <div class="category-icon"><i class="fas fa-laptop"></i></div>
            <div class="category-name">Категория 1</div>
            <div class="category-desc">Электроника</div>
            <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
          </div>
          <div class="category-item" data-category="2">
            <div class="category-icon"><i class="fas fa-tshirt"></i></div>
            <div class="category-name">Категория 2</div>
            <div class="category-desc">Одежда</div>
            <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
          </div>
          <div class="category-item" data-category="3">
            <div class="category-icon"><i class="fas fa-book"></i></div>
            <div class="category-name">Категория 3</div>
            <div class="category-desc">Книги</div>
            <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
          </div>
          <div class="category-item" data-category="4">
            <div class="category-icon"><i class="fas fa-home"></i></div>
            <div class="category-name">Категория 4</div>
            <div class="category-desc">Для дома</div>
            <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
          </div>
          <div class="category-item" data-category="5">
            <div class="category-icon"><i class="fas fa-dumbbell"></i></div>
            <div class="category-name">Категория 5</div>
            <div class="category-desc">Спорт</div>
            <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
          </div>
          <div class="category-item" data-category="6">
            <div class="category-icon"><i class="fas fa-car"></i></div>
            <div class="category-name">Категория 6</div>
            <div class="category-desc">Автотовары</div>
            <div class="checkbox-wrapper"><div class="custom-checkbox"></div></div>
          </div>
        </div>

        <div class="input-group">
          <label for="categoryOther"><i class="fas fa-pen"></i> Другое (уточнение категории)</label>
          <input id="categoryOther" type="text" placeholder="Например: косметика, аксессуары..." />
        </div>

        <div class="controls">
          <div></div>
          <button class="btn btn-next" id="next1">
            <span>Далее</span><i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="form-step" id="step2">
        <h2 class="step-title"><i class="fas fa-cube"></i> Количество + Размеры + Доставка</h2>

        <div class="input-group">
          <label for="quantity"><i class="fas fa-boxes"></i> Количество товара</label>
          <input type="number" id="quantity" min="1" max="100000" value="1">
        </div>

        <div class="input-group">
          <label><i class="fas fa-ruler-combined"></i> Размеры (самостоятельно)</label>
          <div class="row3">
            <input type="number" id="len" min="0" step="0.01" placeholder="Длина">
            <input type="number" id="wid" min="0" step="0.01" placeholder="Ширина">
            <input type="number" id="hei" min="0" step="0.01" placeholder="Высота">
          </div>
        </div>

        <div class="input-group">
          <label for="unit"><i class="fas fa-ruler"></i> Единица измерения</label>
          <input type="text" id="unit" placeholder="см / мм / м" value="см">
        </div>

        <div class="input-group">
          <label for="delivery"><i class="fas fa-truck"></i> Выбор доставки</label>
          <select id="delivery">
            <option value="">Выберите вариант</option>
            <option value="deliver_ourselves">Доставим сами</option>
            <option value="pickup_supplier">Забрать с поставщика</option>
            <option value="pickup_cargo">Забрать с карго</option>
          </select>
        </div>

        <div class="input-group">
          <label for="deliveryOther"><i class="fas fa-pen"></i> Другое (доставка / уточнение)</label>
          <input id="deliveryOther" type="text" placeholder="Адрес, контакты, время, комментарии..." />
        </div>

        <div class="controls">
          <button class="btn btn-prev" id="prev2"><i class="fas fa-arrow-left"></i><span>Назад</span></button>
          <button class="btn btn-next" id="next2"><span>Далее</span><i class="fas fa-arrow-right"></i></button>
        </div>

        <div class="tiny" style="margin-top:10px;">
          Чтобы перейти далее: заполните количество, длина/ширина/высота, единицу измерения и выберите доставку.
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="form-step" id="step3">
        <h2 class="step-title"><i class="fas fa-concierge-bell"></i> Доп. услуги + Другое</h2>

        <div class="services-grid">
          <div class="service-item" data-service="packaging">
            <div class="service-info">
              <div class="service-icon"><i class="fas fa-box-open"></i></div>
              <div class="service-name">Упаковать</div>
            </div>
            <div class="custom-checkbox"></div>
          </div>

          <div class="service-item" data-service="sticker">
            <div class="service-info">
              <div class="service-icon"><i class="fas fa-sticky-note"></i></div>
              <div class="service-name">Наклейка</div>
            </div>
            <div class="custom-checkbox"></div>
          </div>

          <div class="service-item" data-service="defect">
            <div class="service-info">
              <div class="service-icon"><i class="fas fa-search"></i></div>
              <div class="service-name">Брак (проверка)</div>
            </div>
            <div class="custom-checkbox"></div>
          </div>

          <div class="service-item" data-service="marking">
            <div class="service-info">
              <div class="service-icon"><i class="fas fa-tag"></i></div>
              <div class="service-name">Маркировка</div>
            </div>
            <div class="custom-checkbox"></div>
          </div>

          <div class="service-item" data-service="assembly">
            <div class="service-info">
              <div class="service-icon"><i class="fas fa-tools"></i></div>
              <div class="service-name">Сборка</div>
            </div>
            <div class="custom-checkbox"></div>
          </div>
        </div>

        <div class="input-group">
          <label for="servicesOther"><i class="fas fa-pen"></i> Другое (услуги / уточнение)</label>
          <input id="servicesOther" type="text" placeholder="Например: паллетирование, усиленная упаковка..." />
        </div>

        <div class="controls">
          <button class="btn btn-prev" id="prev3"><i class="fas fa-arrow-left"></i><span>Назад</span></button>
          <button class="btn btn-next" id="next3"><span>Далее</span><i class="fas fa-arrow-right"></i></button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="form-step" id="step4">
        <h2 class="step-title"><i class="fas fa-map-marked-alt"></i> Склад + Карта + Контакты</h2>

        <div class="input-group">
          <label for="shipWarehouse"><i class="fas fa-warehouse"></i> Отгрузка на какой склад</label>
          <select id="shipWarehouse">
            <option value="">Выберите</option>
            <option value="WB">ВБ</option>
            <option value="OZON">ОЗОН</option>
            <option value="YANDEX">ЯНДЕКС</option>
            <option value="FBS">FBS</option>
          </select>
        </div>

        <div class="input-group">
          <label for="shipWarehouseOther"><i class="fas fa-pen"></i> Другое (склад / уточнение)</label>
          <input id="shipWarehouseOther" type="text" placeholder="Адрес, номер склада, примечания..." />
        </div>

        <div class="map-container">
          <div class="map-instructions">
            <div class="map-point"><div class="point-indicator point-1"></div><span>Точка 1: место товара</span></div>
            <div class="map-point"><div class="point-indicator point-2"></div><span>Точка 2: место хранения</span></div>
            <small>2 клика = 2 точки. Третий клик — сброс.</small>
          </div>
          <div id="map"></div>
        </div>

        <div class="input-group">
          <label for="contactName"><i class="fas fa-user"></i> Имя</label>
          <input id="contactName" type="text" placeholder="Ваше имя" />
        </div>

        <div class="input-group">
          <label for="contactPhone"><i class="fas fa-phone"></i> Номер</label>
          <input id="contactPhone" type="text" placeholder="+7 ..." />
        </div>

        <div class="input-group">
          <label for="commentFinal"><i class="fas fa-comment"></i> Комментарий</label>
          <textarea id="commentFinal" placeholder="Любые уточнения по заявке"></textarea>
        </div>

        <div class="controls">
          <button class="btn btn-prev" id="prev4"><i class="fas fa-arrow-left"></i><span>Назад</span></button>
          <button class="btn btn-submit" id="submit"><span>Отправка запроса</span><i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="tiny" style="margin-top:10px;">
          Для отправки: выберите склад, поставьте 2 точки на карте, заполните имя и номер.
        </div>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // Telegram WebApp (если открыто внутри Telegram)
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) { tg.ready(); tg.expand(); }

    // State
    const state = {
      currentStep: 1,
      selectedCategory: null,
      categoryOther: "",

      quantity: 1,
      dims: { len: null, wid: null, hei: null, unit: "см" },

      delivery: "",
      deliveryOther: "",

      services: [],
      servicesOther: "",

      shipWarehouse: "",
      shipWarehouseOther: "",

      points: { point1: null, point2: null },

      contact: { name: "", phone: "", comment: "" },
    };

    // Leaflet map
    let map = null;
    let point1Marker = null;
    let point2Marker = null;
    let line = null;

    function initMap() {
      map = L.map("map", { zoomControl: true }).setView([55.7558, 37.6173], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);

      map.on("click", (e) => {
        const { lat, lng } = e.latlng;

        if (!state.points.point1) {
          state.points.point1 = { lat, lng };
          if (point1Marker) map.removeLayer(point1Marker);
          point1Marker = L.marker([lat, lng], {
            icon: L.divIcon({
              className: "custom-marker",
              html: '<div style="background:#4f46e5;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>'
            })
          }).addTo(map).bindPopup("Точка 1: место товара").openPopup();
          updateButtons();
          return;
        }

        if (!state.points.point2) {
          state.points.point2 = { lat, lng };
          if (point2Marker) map.removeLayer(point2Marker);
          point2Marker = L.marker([lat, lng], {
            icon: L.divIcon({
              className: "custom-marker",
              html: '<div style="background:#10b981;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>'
            })
          }).addTo(map).bindPopup("Точка 2: место хранения").openPopup();

          if (line) map.removeLayer(line);
          line = L.polyline(
            [[state.points.point1.lat, state.points.point1.lng], [state.points.point2.lat, state.points.point2.lng]],
            { color:"#4f46e5", weight:3, opacity:.7, dashArray:"10,10" }
          ).addTo(map);

          updateButtons();
          return;
        }

        resetMapPoints(); // 3-й клик — сброс
        updateButtons();
      });
    }

    function resetMapPoints() {
      state.points.point1 = null;
      state.points.point2 = null;
      if (point1Marker) { map.removeLayer(point1Marker); point1Marker = null; }
      if (point2Marker) { map.removeLayer(point2Marker); point2Marker = null; }
      if (line) { map.removeLayer(line); line = null; }
    }

    // DOM helpers
    const $ = (id) => document.getElementById(id);

    function setProgress(step) {
      document.querySelectorAll(".progress-step").forEach(el => {
        const s = Number(el.dataset.step);
        el.classList.remove("active");
        if (s < step) el.classList.add("completed");
        else el.classList.remove("completed");
        if (s === step) el.classList.add("active");
      });
    }

    function showStep(step) {
      const cur = $(`step${state.currentStep}`);
      const nxt = $(`step${step}`);
      if (!cur || !nxt) return;

      cur.style.animation = "slideOut 0.45s ease forwards";
      setTimeout(() => {
        cur.classList.remove("active");
        cur.style.animation = "";
        nxt.classList.add("active");
        nxt.style.animation = "slideIn 0.45s ease forwards";

        state.currentStep = step;
        setProgress(step);

        // Важно для Leaflet при появлении карты
        if (step === 4) setTimeout(() => map && map.invalidateSize(), 120);

        updateButtons();

        // Автоскролл вверх внутри form-container, чтобы видеть заголовок шага
        document.querySelector(".form-container").scrollTop = 0;
      }, 420);
    }

    function updateButtons() {
      // Step 1: category required
      if (state.currentStep === 1) {
        $("next1").disabled = !state.selectedCategory;
      }

      // Step 2: qty + dims + unit + delivery required
      if (state.currentStep === 2) {
        const qty = Number($("quantity").value || 0);
        const len = Number($("len").value || 0);
        const wid = Number($("wid").value || 0);
        const hei = Number($("hei").value || 0);
        const unit = ($("unit").value || "").trim();
        const delivery = ($("delivery").value || "").trim();
        $("next2").disabled = !(qty >= 1 && len > 0 && wid > 0 && hei > 0 && unit && delivery);
      }

      // Step 3: always allowed
      if (state.currentStep === 3) {
        $("next3").disabled = false;
      }

      // Step 4: warehouse + 2 points + name + phone
      if (state.currentStep === 4) {
        const wh = ($("shipWarehouse").value || "").trim();
        const hasPoints = !!state.points.point1 && !!state.points.point2;
        const name = ($("contactName").value || "").trim();
        const phone = ($("contactPhone").value || "").trim();
        $("submit").disabled = !(wh && hasPoints && name && phone);
      }
    }

    // SQL
    function sqlEscape(str) {
      if (str === null || str === undefined) return "";
      return String(str).replace(/\\/g, "\\\\").replace(/'/g, "''");
    }
    function toJson(value) { return JSON.stringify(value ?? null); }

    function buildPayload() {
      return {
        category: state.selectedCategory,
        category_other: state.categoryOther,

        quantity: state.quantity,
        dimensions: state.dims,

        delivery: state.delivery,
        delivery_other: state.deliveryOther,

        services: state.services,
        services_other: state.servicesOther,

        ship_warehouse: state.shipWarehouse,
        ship_warehouse_other: state.shipWarehouseOther,

        point1: state.points.point1,
        point2: state.points.point2,

        contact_name: state.contact.name,
        contact_phone: state.contact.phone,
        comment: state.contact.comment,

        ts: new Date().toISOString()
      };
    }

    function buildSqlInsert(orderId, payload) {
      const p = payload;
      const cols = [
        "order_id","category","category_other",
        "quantity","len","wid","hei","unit",
        "delivery","delivery_other",
        "services_json","services_other",
        "ship_warehouse","ship_warehouse_other",
        "point1_json","point2_json",
        "contact_name","contact_phone","comment",
        "created_at"
      ];
      const values = [
        `'${sqlEscape(orderId)}'`,
        `'${sqlEscape(p.category)}'`,
        `'${sqlEscape(p.category_other)}'`,
        Number(p.quantity || 0),
        Number(p.dimensions?.len || 0),
        Number(p.dimensions?.wid || 0),
        Number(p.dimensions?.hei || 0),
        `'${sqlEscape(p.dimensions?.unit || "")}'`,
        `'${sqlEscape(p.delivery)}'`,
        `'${sqlEscape(p.delivery_other)}'`,
        `'${sqlEscape(toJson(p.services))}'`,
        `'${sqlEscape(p.services_other)}'`,
        `'${sqlEscape(p.ship_warehouse)}'`,
        `'${sqlEscape(p.ship_warehouse_other)}'`,
        `'${sqlEscape(toJson(p.point1))}'`,
        `'${sqlEscape(toJson(p.point2))}'`,
        `'${sqlEscape(p.contact_name)}'`,
        `'${sqlEscape(p.contact_phone)}'`,
        `'${sqlEscape(p.comment)}'`,
        `'${sqlEscape(p.ts)}'`
      ];
      return `INSERT INTO orders (${cols.join(", ")})\nVALUES (${values.join(", ")});`;
    }

    // Overlay
    const overlay = $("acceptOverlay");
    const sqlBox = $("sqlBox");
    const acceptSub = $("acceptSub");

    function showAccepted(orderId, sql) {
      acceptSub.textContent = `ID: ${orderId}`;
      sqlBox.textContent = sql;
      overlay.classList.add("show");
    }

    $("closeOverlayBtn").addEventListener("click", () => overlay.classList.remove("show"));

    $("copySqlBtn").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(sqlBox.textContent);
        $("copySqlBtn").textContent = "Скопировано";
        setTimeout(()=> $("copySqlBtn").textContent = "Копировать SQL", 900);
      }catch{}
    });

    // Listeners
    function setupEventListeners() {
      // Step1 categories (single)
      document.querySelectorAll(".category-item").forEach(item => {
        item.addEventListener("click", () => {
          const cat = item.dataset.category;
          document.querySelectorAll(".category-item").forEach(x => {
            x.classList.remove("selected");
            x.querySelector(".custom-checkbox").classList.remove("checked");
          });
          item.classList.add("selected");
          item.querySelector(".custom-checkbox").classList.add("checked");
          state.selectedCategory = cat;
          updateButtons();
        });
      });

      $("categoryOther").addEventListener("input", (e) => state.categoryOther = e.target.value);

      // Step2
      $("quantity").addEventListener("input", (e) => {
        const v = Math.max(1, parseInt(e.target.value || "1", 10));
        e.target.value = v;
        state.quantity = v;
        updateButtons();
      });
      ["len","wid","hei","unit","delivery","deliveryOther"].forEach(id => {
        $(id).addEventListener("input", updateButtons);
        $(id).addEventListener("change", updateButtons);
      });

      // Step3 services
      document.querySelectorAll(".service-item").forEach(item => {
        item.addEventListener("click", () => {
          const key = item.dataset.service;
          const cb = item.querySelector(".custom-checkbox");
          cb.classList.toggle("checked");
          if (cb.classList.contains("checked")) {
            if (!state.services.includes(key)) state.services.push(key);
          } else {
            state.services = state.services.filter(x => x !== key);
          }
        });
      });
      $("servicesOther").addEventListener("input", (e)=> state.servicesOther = e.target.value);

      // Step4
      $("shipWarehouse").addEventListener("change", updateButtons);
      $("shipWarehouseOther").addEventListener("input", (e)=> state.shipWarehouseOther = e.target.value);
      $("contactName").addEventListener("input", updateButtons);
      $("contactPhone").addEventListener("input", updateButtons);
      $("commentFinal").addEventListener("input", () => {});

      // Nav
      $("next1").addEventListener("click", () => showStep(2));
      $("prev2").addEventListener("click", () => showStep(1));
      $("next2").addEventListener("click", () => showStep(3));
      $("prev3").addEventListener("click", () => showStep(2));
      $("next3").addEventListener("click", () => showStep(4));
      $("prev4").addEventListener("click", () => showStep(3));

      // Submit
      $("submit").addEventListener("click", () => {
        // collect step2
        state.dims.len = Number($("len").value || 0);
        state.dims.wid = Number($("wid").value || 0);
        state.dims.hei = Number($("hei").value || 0);
        state.dims.unit = ($("unit").value || "").trim();

        state.delivery = ($("delivery").value || "").trim();
        state.deliveryOther = ($("deliveryOther").value || "").trim();

        state.shipWarehouse = ($("shipWarehouse").value || "").trim();

        state.contact.name = ($("contactName").value || "").trim();
        state.contact.phone = ($("contactPhone").value || "").trim();
        state.contact.comment = ($("commentFinal").value || "").trim();

        updateButtons();
        if ($("submit").disabled) return;

        const payload = buildPayload();
        const orderId = `ORD-${Math.floor(100000 + Math.random()*900000)}`;
        const sql = buildSqlInsert(orderId, payload);

        showAccepted(orderId, sql);

        // send to Telegram WebApp
       if (tg) {
  tg.sendData(JSON.stringify({ order_id: orderId, payload, sql }));
} else {
  console.log("Откройте через Telegram Mini App, чтобы отправить в бота.");
}

      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      setupEventListeners();
      updateButtons();
    });
  </script>
</body>
</html>




